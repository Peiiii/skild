# Skillset 功能 PRD

> **版本**: v1.0 Draft  
> **日期**: 2026-01-14  
> **状态**: 设计中

---

## 1. 概述

### 1.1 背景

Skild 当前支持单个 Skill 的安装与管理。但用户常常需要安装一组相关的 Skills（例如"数据分析套件"或"前端开发工具包"）。目前没有原生支持批量安装或组合管理的能力。

### 1.2 目标

- 允许 Skill 声明对其他 Skills 的依赖
- 支持"Skillset"作为纯聚合包，一键安装多个 Skills
- 保持与现有 Skill 规范的兼容性

### 1.3 非目标（MVP 排除）

- 复杂的版本解析算法
- 自动解决版本冲突
- 依赖树可视化

---

## 2. 核心概念

### 2.1 Skill 依赖

任何 Skill 可以在 `SKILL.md` 的 frontmatter 中声明 `dependencies`：

```yaml
---
name: my-skill
version: 1.0.0
dependencies:
  - @anthropic/csv
  - @skild/pandas
---
```

### 2.2 Skillset

Skillset 是一个特殊的 Skill：
- 使用 `skillset: true` 标记
- 主要用途是聚合多个 Skills
- 本身可以有或没有实际内容

```yaml
---
name: data-analyst-pack
version: 1.0.0
description: All-in-one skill pack for data analysts
skillset: true
dependencies:
  - @anthropic/csv
  - @anthropic/pandas
  - @skild/sql-helper
---
```

---

## 3. 依赖引用格式

| 格式 | 示例 | 说明 |
|------|------|------|
| **Registry** | `@scope/skill` | 从 Skild Registry 安装 |
| **Registry + 版本** | `@scope/skill@^1.0.0` | 指定版本范围 |
| **GitHub** | `github:owner/repo/path` | 从 GitHub 安装 |
| **相对路径** | `./skills/sub-skill` | Skill 内部子目录 |

---

## 4. 安装规则

### 4.1 核心规则

| 规则 | 描述 |
|------|------|
| **Skillset 本体** | ✅ 始终安装在顶层 |
| **外部依赖**（Registry/GitHub） | ✅ 扁平化安装到顶层 |
| **相对路径依赖** | ✅ 保留目录结构，放在 Skillset 内 |
| **版本冲突** | ⚠️ MVP 直接报错，用户手动解决 |

### 4.2 相对路径规则

- ✅ 允许任意相对路径，只要解析后仍在 Skillset 根目录内
- ❌ 禁止路径逃逸（`..` 导致越过根目录直接报错）
- ✅ 目标必须是目录且包含 `SKILL.md`
- ⚠️ 相对路径依赖不会被 Agent 作为独立技能扫描，仅作为 Skillset 私有资源

> **注意**：如果希望子 Skill 被 Agent 独立发现和使用，应将其作为外部依赖单独发布。

### 4.3 安装示例

**输入：**

```yaml
# @myhandle/data-analyst-pack
skillset: true
dependencies:
  - @anthropic/csv          # 外部依赖
  - @skild/pandas           # 外部依赖
  - ./utils/lint-rules      # 内部依赖（相对路径）
  - ./helpers/formatter     # 内部依赖（相对路径）
```

**安装后目录结构：**

```
~/.claude/skills/
├── data-analyst-pack/         # Skillset 本体（顶层）
│   ├── SKILL.md
│   ├── utils/                  # 相对路径依赖（保留结构）
│   │   └── lint-rules/
│   │       └── SKILL.md
│   └── helpers/                # 相对路径依赖（保留结构）
│       └── formatter/
│           └── SKILL.md
├── csv/                        # 外部依赖（扁平化）
│   └── SKILL.md
└── pandas/                     # 外部依赖（扁平化）
    └── SKILL.md
```

### 4.3 安装流程

```
1. 解析主 Skill 的 SKILL.md
2. 提取 dependencies 列表
3. 对每个依赖：
   a. 解析来源（Registry / GitHub / 相对路径）
   b. 检查是否已安装
   c. 检查版本冲突
   d. 递归解析子依赖
4. 安装所有依赖（扁平化到顶层）
5. 安装主 Skill 本身
```

---

## 5. CLI 命令

### 5.1 安装

```bash
# 安装带依赖的 Skill
skild install @myhandle/data-analyst-pack

# 输出示例
Installing @myhandle/data-analyst-pack...
  → Installing dependency: @anthropic/csv
  → Installing dependency: @skild/pandas
  → Installing dependency: ./skills/lint-rules
✓ Installed 4 skills
```

### 5.2 卸载

```bash
# 卸载 Skillset（仅卸载本身，不卸载依赖）
skild uninstall data-analyst-pack

# 卸载 Skillset 及其所有依赖
skild uninstall data-analyst-pack --with-deps
```

### 5.3 列表

```bash
skild list

# 输出示例（标记依赖关系）
claude:
  data-analyst-pack (skillset)
  csv (dep of: data-analyst-pack)
  pandas (dep of: data-analyst-pack)
  lint-rules (dep of: data-analyst-pack)
```

---

## 6. 元数据存储

### 6.1 install.json 扩展

每个 Skill 的 `.skild/install.json` 增加依赖信息：

```json
{
  "name": "data-analyst-pack",
  "version": "1.0.0",
  "skillset": true,
  "installedDependencies": [
    { "name": "csv", "source": "@anthropic/csv" },
    { "name": "pandas", "source": "@skild/pandas" },
    { "name": "lint-rules", "source": "./skills/lint-rules" }
  ]
}
```

### 6.2 被依赖追踪

每个被安装的依赖记录"被谁引用"：

```json
{
  "name": "csv",
  "version": "1.2.0",
  "dependedBy": ["data-analyst-pack", "another-pack"]
}
```

---

## 7. 版本冲突处理（MVP）

```bash
skild install @scope/pack-a
# pack-a depends on csv@^1.0.0

skild install @scope/pack-b
# pack-b depends on csv@^2.0.0

# 输出
Error: Version conflict detected
  Installed: csv@1.2.0 (required by pack-a)
  Requested: csv@^2.0.0 (required by pack-b)

Please resolve manually:
  skild uninstall csv
  skild install @anthropic/csv@2.0.0
```

---

## 8. UI 展示（Skild Hub）

### 8.1 Skillset 详情页

- 标记为 "Skillset"（Badge）
- 展示包含的依赖列表
- 一键安装按钮

### 8.2 Discover 页面

- Skillset 在搜索结果中可筛选
- 展示"包含 N 个 Skills"

---

## 9. 实现优先级

### Phase 1 (MVP)

- [ ] SKILL.md 支持 `dependencies` 字段
- [ ] SKILL.md 支持 `skillset: true` 标记
- [ ] CLI `install` 支持递归安装依赖
- [ ] 扁平化安装到顶层
- [ ] 版本冲突检测并报错

### Phase 2

- [ ] CLI `uninstall --with-deps`
- [ ] `skild list` 展示依赖关系
- [ ] Skild Hub 展示 Skillset

### Phase 3

- [ ] 版本智能解析（自动选择兼容版本）
- [ ] 依赖锁定文件

---

## 10. 风险与考量

| 风险 | 缓解措施 |
|------|----------|
| 循环依赖 | 安装时检测并报错 |
| 依赖爆炸 | 限制递归深度（建议 ≤10） |
| 大量依赖影响性能 | 并行安装 |
| 私有字段冲突 | 使用 `skillset: true` 而非 `type` |

---

## 11. 开放问题

1. **相对路径的 Skill 名称如何确定？**
   - 使用路径最后一段？（`./skills/lint-rules` → `lint-rules`）
   - 使用 SKILL.md 中的 `name`？

2. **Skillset 是否支持嵌套？**
   - Skillset A 依赖 Skillset B？
   - MVP 建议支持（和普通依赖一样处理）

3. **GitHub 依赖是否支持版本？**
   - `github:owner/repo@v1.0.0`？
   - MVP 建议支持 ref（branch/tag）
