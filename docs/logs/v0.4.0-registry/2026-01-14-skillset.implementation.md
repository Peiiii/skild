# 2026-01-14 Skillset 迭代实现记录（v0.4.0-registry）

## 已实现内容

- `skillset: true` + `dependencies` 解析
- 依赖安装与冲突检测
- 内联依赖路径安全检查（不越界）
- `.skild/install.json` 记录依赖关系
- CLI 列表展示依赖与 skillset 标记
- CLI 卸载 `--with-deps`

---

## 代码落点

### Core

- `packages/core/src/types.ts`
  - 增加 `skillset`, `dependencies`, `installedDependencies`, `dependedBy`
- `packages/core/src/skill.ts`
  - frontmatter 校验 `skillset` 与 `dependencies`
- `packages/core/src/registry.ts`
  - 支持 semver range 解析（客户端选最大满足版本）
- `packages/core/src/lifecycle.ts`
  - 依赖解析/安装/冲突检测/循环检测
  - 内联依赖路径限制（不越界）
  - 安装记录的依赖/被依赖关系写入
- `packages/core/src/errors.ts`
  - 新增依赖相关错误码

### CLI

- `packages/cli/src/commands/list.ts`
  - 展示 skillset 标记与依赖关系
  - 列出内联依赖为“dep of: <skillset>”
- `packages/cli/src/commands/uninstall.ts`
  - 支持 `--with-deps`
- `packages/cli/src/index.ts`
  - CLI flag `--with-deps` 文案

---

## 关键规则落地

- Skillset 本体始终安装到顶层
- 外部依赖扁平化安装到顶层
- 相对路径依赖安装在 skillset 目录内（保留结构）
- 相对路径必须在 skillset 根目录内
- 版本冲突直接报错

---

## 验证方法与记录

- `pnpm lint`
- `pnpm typecheck`
- `pnpm build`
- `pnpm dev:smoke`

### 功能验证（手动）

```
mkdir -p tmp-skillset/subskill
cat > tmp-skillset/SKILL.md <<'EOF'
---
name: local-pack
description: local pack
version: 0.1.0
skillset: true
dependencies:
  - ./subskill
---
EOF

cat > tmp-skillset/subskill/SKILL.md <<'EOF'
---
name: inline-skill
description: inline skill
version: 0.1.0
---
EOF

skild install ./tmp-skillset
skild list
skild uninstall local-pack
```

预期：
- `local-pack` 安装在顶层目录
- `local-pack/subskill/` 作为内联依赖存在
- `skild list` 显示 skillset 标记与依赖关系

执行结果：通过

---

## 发布部署流程

- 本迭代涉及 `@skild/core` 与 `skild`（CLI）发布
- 依流程执行（见 `docs/processes/npm-release-process.md`）

发布结果：
- `skild@0.2.3`
- `@skild/core@0.2.3`
