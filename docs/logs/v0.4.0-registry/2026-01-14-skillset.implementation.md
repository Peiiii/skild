# 2026-01-14 Skillset 迭代实现记录（v0.4.0-registry）

## 已实现内容

- `skillset: true` + `dependencies` 解析
- 依赖安装与冲突检测
- 内联依赖路径安全检查（不越界）
- `.skild/install.json` 记录依赖关系
- CLI 列表展示依赖与 skillset 标记
- CLI 卸载 `--with-deps`
- CLI 安装支持多 skill 源：自动发现子目录 skills，并支持 `--recursive` + 交互确认 + `--json` 结构化输出
- 前端展示 Skillset 标记（Discover / Detail / My Skills）
- 前端详情页展示 Skillset `dependencies`

---

## 代码落点

### Core

- `packages/core/src/types.ts`
  - 增加 `skillset`, `dependencies`, `installedDependencies`, `dependedBy`
- `packages/core/src/skill.ts`
  - frontmatter 校验 `skillset` 与 `dependencies`
- `packages/core/src/registry.ts`
  - 支持 semver range 解析（客户端选最大满足版本）
- `packages/core/src/lifecycle.ts`
  - 依赖解析/安装/冲突检测/循环检测
  - 内联依赖路径限制（不越界）
  - 安装记录的依赖/被依赖关系写入
- `packages/core/src/materialize.ts`
  - Source 一次性物化到临时目录（用于多 skill 源的递归安装，避免重复 clone）
- `packages/core/src/errors.ts`
  - 新增依赖相关错误码

### CLI

- `packages/cli/src/commands/list.ts`
  - 展示 skillset 标记与依赖关系
  - 列出内联依赖为“dep of: <skillset>”
- `packages/cli/src/commands/uninstall.ts`
  - 支持 `--with-deps`
- `packages/cli/src/commands/install.ts`
  - 多 skill 源识别：当 source 根目录缺少 `SKILL.md` 时，扫描子目录并支持 `--recursive` / 交互确认
- `packages/cli/src/commands/install-discovery.ts`
  - 多 skill 发现逻辑抽离（提升可维护性）
- `packages/cli/src/index.ts`
  - CLI flag `--with-deps` 文案
  - CLI flags：`--recursive`, `--yes`, `--depth`, `--max-skills`

### Registry（后端）

- `workers/registry/migrations/0007_skillset_metadata.sql`
  - `skills.skillset`, `skills.dependencies_json`, `discover_items.skillset`
- `workers/registry/src/index.ts`
  - 发布接口接收 `skillset` 与 `dependencies`
  - 技能/发现接口返回 `skillset`
- `workers/registry/src/discover-items.ts`
  - Discover 返回 `skillset` 字段

### Console（前端）

- `apps/console/src/components/skillset-badge.tsx`
  - 统一 Skillset 标记组件（避免多处重复实现）
- `apps/console/src/lib/skillset.ts`
  - `skillset` 标记归一化 + `dependencies_json` 解析辅助
- `apps/console/src/ui/pages/SkillsPage.tsx`
  - Discover 列表显示 Skillset 标记
- `apps/console/src/ui/pages/SkillDetailPage.tsx`
  - 详情页显示 Skillset 标记
  - Skillset 展示 `dependencies` 列表（Bundled / Registry link）
- `apps/console/src/ui/pages/MySkillsPage.tsx`
  - Publisher 列表显示 Skillset 标记

---

## 关键规则落地

- Skillset 本体始终安装到顶层
- 外部依赖扁平化安装到顶层
- 相对路径依赖安装在 skillset 目录内（保留结构）
- 相对路径必须在 skillset 根目录内
- 版本冲突直接报错

---

## 验证方法与记录

- `pnpm lint`
- `pnpm typecheck`
- `pnpm build`
- `pnpm dev:smoke`
- `pnpm release:check`

执行结果：通过

### 多 skill 安装 smoke（`--recursive` + `--json`）

```
SKILD_HOME="$(mktemp -d)" pnpm -s cli install <repo-or-dir> --json
SKILD_HOME="$(mktemp -d)" pnpm -s cli install <repo-or-dir> --recursive --json
```

预期：
- 非 `--recursive`：返回 `MULTI_SKILL_SOURCE`，并列出发现的 skills
- `--recursive`：完成递归安装，并输出 `recursiveSkillCount`

执行结果：通过

### Example Skillset（仓库内示例）

- `examples/hello-skillset`
  - `skillset: true`
  - `dependencies` 为相对路径内联依赖（不会触发 registry 安装）
- `examples/kitchen-sink-skillset`
  - 包含内联依赖 + GitHub 依赖 + Registry 依赖（更贴近真实 Skillset）
- `examples/registry-dep-skill`
  - 用于本地 registry 发布的依赖 skill（供 kitchen-sink smoke 使用）
- `skillsets/awesome-claude-skills/*`
  - 基于 `VoltAgent/awesome-claude-skills` 的 curated Skillsets（依赖指向 upstream GitHub skills）
- `skillsets/obra-superpowers-pack`
  - 基于 `obra/superpowers/tree/main/skills` 的全量 Skillset（依赖直接使用 GitHub URL，易读易写）

本地安装验证（project scope，避免污染 repo）：

```
TMP="$(mktemp -d /Users/peiwang/Projects/skild/.tmp/skillset-smoke.XXXXXX)"
node /Users/peiwang/Projects/skild/packages/cli/dist/index.js install /Users/peiwang/Projects/skild/examples/hello-skillset --target codex --local --json
find "$TMP/.codex/skills/hello-skillset" -maxdepth 4 -type f -name 'SKILL.md' -print
```

预期：
- 安装目录存在 `hello-skillset/skills/*/SKILL.md`（内联依赖保留结构）
- `.skild/install.json` 包含 `skillset: true` + `installedDependencies`

执行结果：通过

Kitchen-sink 端到端安装验证（inline + github + registry）：

```
pnpm build:cli
node scripts/dev/skillset-kitchen-sink-smoke.mjs
```

预期：
- 自动启动本地 registry、注册/登录、发布 `registry-dep-skill`
- `skild install @<handle>/registry-dep-skill` 可直接解析 `latest` dist-tag（不显式传 `--registry` / `SKILD_REGISTRY_URL`）
- 安装 `kitchen-sink-skillset` 后 `installedDependencies` 同时包含：`inline`、`degit-shorthand`/`github-url`、`registry`
- 使用 `SKILD_HOME` 隔离测试，不污染真实 `~/.skild`

执行结果：通过

Awesome Claude Skillsets 安装验证（GitHub deps）：

```
TMP="$(mktemp -d /Users/peiwang/Projects/skild/.tmp/skillset-awesome-smoke.XXXXXX)"
node packages/cli/dist/index.js install ./skillsets/awesome-claude-skills/claude-office-pack --target codex --local --json
find "$TMP/.codex/skills" -maxdepth 2 -name SKILL.md -print
```

执行结果：通过

Obra Superpowers Pack 安装验证（GitHub deps）：

```
pnpm build:cli
TMP="$(mktemp -d /tmp/skild-superpowers-pack.XXXXXX)"
(cd "$TMP" && node /Users/peiwang/Projects/skild/packages/cli/dist/index.js install /Users/peiwang/Projects/skild/skillsets/obra-superpowers-pack --target codex --local --json)
```

执行结果：通过

### 本地 Registry 发布/验证（仅 smoke）

启动本地 registry：

```
pnpm dev:registry
```

注册/登录/发布：

```
node packages/cli/dist/index.js signup --registry http://localhost:18787 --email <email> --handle <handle> --password <password>
node packages/cli/dist/index.js login --registry http://localhost:18787 --handle-or-email <handle> --password <password>
node packages/cli/dist/index.js publish --dir examples/hello-skillset --registry http://localhost:18787 --json
```

接口校验（skillset + dependencies_json）：

```
curl -fsS 'http://localhost:18787/skills/<handle>/hello-skillset'
curl -fsS 'http://localhost:18787/discover?q=hello-skillset'
```

执行结果：通过

### 功能验证（手动）

```
mkdir -p tmp-skillset/subskill
cat > tmp-skillset/SKILL.md <<'EOF'
---
name: local-pack
description: local pack
version: 0.1.0
skillset: true
dependencies:
  - ./subskill
---
EOF

cat > tmp-skillset/subskill/SKILL.md <<'EOF'
---
name: inline-skill
description: inline skill
version: 0.1.0
---
EOF

skild install ./tmp-skillset
skild list
skild uninstall local-pack
```

预期：
- `local-pack` 安装在顶层目录
- `local-pack/subskill/` 作为内联依赖存在
- `skild list` 显示 skillset 标记与依赖关系

执行结果：通过

---

## 发布部署流程

- 本迭代涉及 `@skild/core` 与 `skild`（CLI）发布
- 依流程执行（见 `docs/processes/npm-release-process.md`）
- Console 本次为 UI 改动，已执行线上部署（`pnpm deploy:console`）

发布结果：
- `skild@0.4.0`
- `@skild/core@0.4.0`

---

## 补充迭代：Alias 优先展示/复制（Console）

### 已实现内容

- 当存在 `alias` 时：
  - 卡片/详情标题优先显示 `alias`，并额外展示 canonical 原名（弱化、等宽）
  - 复制安装命令优先使用 `skild install <alias>`
- 当不存在 `alias` 时：
  - UI 明确展示 `no alias`（可见但弱化）
- 统一逻辑 helper（避免多处重复实现）：`apps/console/src/lib/install.ts`

### 代码落点

- `apps/console/src/lib/install.ts`
- `apps/console/src/ui/pages/DiscoverPage.tsx`
- `apps/console/src/ui/pages/SkillDetailPage.tsx`
- `apps/console/src/ui/pages/LinkedItemsPage.tsx`
- `apps/console/src/ui/pages/LinkedItemDetailPage.tsx`
- `apps/console/src/ui/pages/MySkillsPage.tsx`

### 验证与部署

本地验证：

- `pnpm lint`
- `pnpm typecheck`
- `pnpm build`

线上部署（Console）：

- `pnpm deploy:console`

线上冒烟（HTTP 可达）：

```
curl -fsS -I https://41b294ba.skild-console.pages.dev/
```

- `@skild/core@0.2.3`

### 本次全量发布闭环（含 Registry/Console）

NPM（Core + CLI）：
- 版本：`@skild/core@0.2.4`、`skild@0.2.4`

Registry（Cloudflare Workers + D1）：
- migrations apply：`workers/registry/migrations/0007_skillset_metadata.sql`
- deploy：`workers/registry` -> `registry.skild.sh`
- 线上冒烟：
  - `GET https://registry.skild.sh/health` -> `{ ok: true }`
  - `GET https://registry.skild.sh/skills?limit=1` -> `skills[*].skillset` 字段存在
  - `GET https://registry.skild.sh/discover?limit=1` -> `items[*].skillset` 字段存在

Console（Cloudflare Pages）：
- deploy：`apps/console` -> `hub.skild.sh` / `console.skild.sh`
- 线上冒烟：
  - `GET https://hub.skild.sh/` -> 200

### 后续发布：`skild@0.2.5`（CLI UX 修复）

- NPM：已发布 `@skild/core@0.2.5`、`skild@0.2.5`
- 变更：修复交互式 `skild login` 的密码提示行（`Password:`）不可见问题（输入仍保持隐藏）
- 本次不涉及 Registry/Console/DB 变更，无需 migrations/deploy

### 后续发布：`skild@0.2.6`（CLI UX 修复）

- NPM：已发布 `@skild/core@0.2.6`、`skild@0.2.6`
- 变更：修复交互式密码输入在编辑（如 Backspace）时提示行异常的问题（改为 raw-mode 密码输入；输入仍保持隐藏）
- 本次不涉及 Registry/Console/DB 变更，无需 migrations/deploy

---

## 后续迭代：Console「Skillsets」独立模块（Registry + Console）

目标：让 Skillset 在前端“更突出”，提供专门的 `Skillsets` 页面（类似 Discover，但只展示 skillset），并采用服务端过滤保证分页正确。

### 变更内容

- Registry：
  - `/discover` 新增 query 参数 `skillset`（可选）
    - `skillset=1|true|yes`：只返回 `skillset: true`
    - `skillset=0|false|no`：只返回 `skillset: false`
- Console：
  - 新增页面 `/skillsets`（只展示 Skillsets）
  - 顶部导航新增 `Skillsets` 入口
  - Discover UI 抽成单一实现（`DiscoverPage`），`/skills` 与 `/skillsets` 共用，避免重复逻辑

### 代码落点

- `workers/registry/src/index.ts`：解析 `/discover?skillset=...`
- `workers/registry/src/discover-items.ts`：`listDiscoverItems(..., { skillset })` 服务端过滤
- `apps/console/src/lib/api.ts`：`listDiscoverItems(..., { skillset })` 透传 query 参数
- `apps/console/src/ui/pages/DiscoverPage.tsx`：通用 Discover UI（skills / skillsets 两种模式）
- `apps/console/src/ui/pages/SkillsetsPage.tsx`：新页面（`DiscoverPage mode="skillsets"`）
- `apps/console/src/ui/pages/SkillsPage.tsx`：改为薄封装（`DiscoverPage mode="skills"`）
- `apps/console/src/router.tsx`：新增路由 `/skillsets`
- `apps/console/src/ui/AppLayout.tsx`：新增顶部导航入口

### 本地验证

- `pnpm lint`
- `pnpm typecheck`
- `pnpm build`
- `pnpm dev:smoke`
- 本地接口验证：
  - `pnpm dev:registry`
  - `curl -fsS 'http://localhost:18787/discover?skillset=1&limit=3'`

执行结果：通过

---

## 后续迭代：Skill 管理页（alias + delete，解耦于 SKILL.md）

目标：提供独立的 Skill 管理入口（`/skills/:scope/:skill/manage`），用于配置 registry 侧 metadata（如 alias）与删除技能；并让“自己提交/发布”的资源都可管理（含 GitHub linked items）。

### 变更内容

- Registry：
  - DB：`skills.alias`（全局唯一，可空）
  - API：
    - `GET /resolve?alias=...`：alias -> registry skill / linked item（供 CLI 短名安装）
    - `POST /publisher/skills/:scope/:skill/alias`：设置/清空 alias（session auth + scope ownership）
    - `DELETE /publisher/skills/:scope/:skill`：删除 skill/skillset（含 dist-tags/versions/discover/download stats）
    - `GET /publisher/linked-items`：列出当前 publisher 提交的 GitHub items
    - `DELETE /publisher/linked-items/:id`：删除 linked item（含 discover/download stats）
- Console：
  - 新增路由：
    - `/skills/:scope/:skill/manage`（SkillManagePage：alias + danger delete）
    - `/linked/:id/manage`（LinkedItemManagePage：danger delete）
  - 详情页：
    - Skill 详情页在 owner 下展示 `Manage` 入口
    - Linked item 详情页在 owner 下展示 `Manage` 入口
  - My Skills：
    - 增加 “My GitHub submissions” 区块，展示自己提交的 linked items，并提供 manage 入口

### 本地验证

- `pnpm lint`
- `pnpm typecheck`
- `pnpm build`
- `pnpm dev:smoke`

执行结果：通过

### 后续补齐：Linked Item Alias + CLI 短名安装

- Registry：
  - DB：`linked_items.alias`（全局唯一，可空）
  - API：
    - `POST /publisher/linked-items/:id/alias`：设置/清空 linked item alias
    - `GET /resolve?alias=...`：支持解析到 linked item（返回 `type=linked` + `spec=<owner/repo/path#ref>`）
    - alias 全局唯一性：在写入时同时检查 skills/linked_items，避免跨表冲突
- Console：
  - linked item manage 页支持配置 alias（并复制 `skild install <alias>`）
  - My Skills 中展示 linked item alias（若存在）
- CLI：
  - `skild install <alias>`：若输入看起来是 alias，则先请求 registry `/resolve`，再按解析结果继续安装
    - registry skill -> 走 registry 安装
    - linked item -> 走 GitHub shorthand 安装

### NPM 发布（CLI）

- `@skild/core@0.2.7`
- `skild@0.2.7`
- 验证（alias 安装 smoke）：
  - `pnpm dlx skild@0.2.7 install superpowers`

---

## 补充迭代：Antigravity 平台支持 + `skild list` 输出优化

### 背景调研结论（Antigravity Skills 路径）

Antigravity（Google Antigravity / Agentic Command Line）推荐的 Skills 路径：

- 项目级别：`./.agent/skills/`
- 全局：`~/.gemini/antigravity/skills/`

### 已实现内容

- 新增 Target 平台：`antigravity`
  - `skild install ... -t antigravity` 安装到 Antigravity 目录
  - `skild list -t antigravity` 列出 Antigravity 目录下安装项
- `skild list` 输出重构，按三类分组展示，显著减少信息噪声：
  - Skillsets
  - Skills
  - Dependencies（并显示 required by）
- 新增可选参数（默认更清爽）：
  - `skild list --paths` 显示安装路径
  - `skild list --verbose` 展示 skillset includes 依赖明细

### 本地验证

- `pnpm lint`
- `pnpm typecheck`
- `pnpm build`
- Smoke（Antigravity 安装）：
  - `pnpm dlx skild@0.2.8 install ./examples/hello-skillset -t antigravity --local`

### NPM 发布（CLI）

- `@skild/core@0.2.8`
- `skild@0.2.8`

---

## 补充迭代：CLI publish 设置 alias（`--alias`）

### 已实现内容

- `skild publish --alias <short-name>`：发布后自动设置 alias（全局唯一）
- alias 校验逻辑收敛到 core（避免多处重复实现）
- Registry alias 写入 API 支持 Bearer token（CLI 可直接调用，不依赖 session cookie）

### 本地验证

- `pnpm lint`
- `pnpm typecheck`
- `pnpm build`
- 本地 registry + CLI 端到端：
  - `pnpm dev:registry`
  - `pnpm dlx skild@0.2.9 publish --registry http://localhost:18787 --dir <skill-dir> --alias <alias>`
  - `GET http://localhost:18787/resolve?alias=<alias>` -> `ok: true`

### 发布部署闭环（Registry + CLI）

- NPM 发布：
  - `@skild/core@0.2.9`
  - `skild@0.2.9`
- migrations apply（remote）：`pnpm deploy:registry`（✅ No migrations to apply）
- deploy（Registry）：`pnpm deploy:registry`（包含 deploy + `/health` smoke）
- 线上冒烟（alias 写入 + resolve）：
  - `POST https://registry.skild.sh/publisher/skills/<scope>/<skill>/alias`（Bearer token）-> `ok: true`
  - `GET https://registry.skild.sh/resolve?alias=<alias>` -> `ok: true`

---

## 补充迭代：`skild install --all`（一次性安装到所有平台）

### 已实现内容

- `skild install <source> --all`：对 `claude/codex/copilot/antigravity` 逐个平台安装（同一 source）
- `--all` 与 `--target` 互斥（避免歧义）
- `--json` 模式输出严格为 JSON（无 spinner/日志污染）

### 本地验证

- `pnpm lint`
- `pnpm typecheck`
- `pnpm build`
- Smoke：
  - `pnpm dlx skild@0.3.1 install ./examples/hello-skillset --all --local --json`
  - 期望：`results[*].platform` 包含 `claude/codex/copilot/antigravity`

### NPM 发布（CLI）

- `skild@0.3.0`（新增 `--all`）
- `skild@0.3.1`（`--json` 纯 JSON 输出）
- `skild@0.3.2`（失败时 exit code 非 0 + 输出错误信息）

### 发布部署闭环（Registry + Console）

- migrations apply（remote）：
  - `0009_linked_item_alias.sql`
- deploy（Registry）：`wrangler deploy` -> `registry.skild.sh`
- deploy（Console）：`pnpm deploy:console` -> `hub.skild.sh`
- 线上冒烟：
  - `GET https://registry.skild.sh/resolve?alias=<nonexistent>` -> 404
  - `GET https://registry.skild.sh/discover?limit=5` -> `items[*].alias` 字段存在

执行结果：通过

### 发布部署闭环（Registry + Console）

- migrations apply（remote）：`wrangler d1 migrations apply skild-registry --remote`（新增 `0008_skill_alias.sql`）
- deploy（Registry）：`wrangler deploy` -> `registry.skild.sh`
- deploy（Console）：`pnpm deploy:console` -> `hub.skild.sh`
- 线上冒烟：
  - `GET https://registry.skild.sh/health` -> `{ ok: true }`
  - `GET https://registry.skild.sh/discover?limit=3` -> `items[*].alias` 字段存在（允许为 null）
  - `GET https://registry.skild.sh/resolve?alias=<nonexistent>` -> 404
  - `GET https://hub.skild.sh/skills/<scope>/<skill>/manage` -> 未登录时跳转至登录页（页面可访问）

执行结果：通过

### 发布部署闭环（Registry + Console）

> 本次为 API 行为变更与前端路由/UI 变更，无新增迁移文件，但仍执行远程 migrations apply 确认无遗漏。

- migrations apply（remote）：`wrangler d1 migrations apply skild-registry --remote` -> ✅ No migrations to apply
- deploy（Registry）：`wrangler deploy` -> `registry.skild.sh`
- deploy（Console）：`pnpm deploy:console` -> `hub.skild.sh`

### 线上冒烟验证

- `GET https://registry.skild.sh/health` -> `{ ok: true }`
- `GET https://registry.skild.sh/discover?skillset=1&limit=10`
  - 期望：`items[*].type === 'registry'` 且 `items[*].skillset === true`
- `GET https://hub.skild.sh/skillsets` -> 200（页面可访问）

执行结果：通过
