# 2026-01-14 Skillset 迭代实现记录（v0.4.0-registry）

## 已实现内容

- `skillset: true` + `dependencies` 解析
- 依赖安装与冲突检测
- 内联依赖路径安全检查（不越界）
- `.skild/install.json` 记录依赖关系
- CLI 列表展示依赖与 skillset 标记
- CLI 卸载 `--with-deps`
- 前端展示 Skillset 标记（Discover / Detail / My Skills）
- 前端详情页展示 Skillset `dependencies`

---

## 代码落点

### Core

- `packages/core/src/types.ts`
  - 增加 `skillset`, `dependencies`, `installedDependencies`, `dependedBy`
- `packages/core/src/skill.ts`
  - frontmatter 校验 `skillset` 与 `dependencies`
- `packages/core/src/registry.ts`
  - 支持 semver range 解析（客户端选最大满足版本）
- `packages/core/src/lifecycle.ts`
  - 依赖解析/安装/冲突检测/循环检测
  - 内联依赖路径限制（不越界）
  - 安装记录的依赖/被依赖关系写入
- `packages/core/src/errors.ts`
  - 新增依赖相关错误码

### CLI

- `packages/cli/src/commands/list.ts`
  - 展示 skillset 标记与依赖关系
  - 列出内联依赖为“dep of: <skillset>”
- `packages/cli/src/commands/uninstall.ts`
  - 支持 `--with-deps`
- `packages/cli/src/index.ts`
  - CLI flag `--with-deps` 文案

### Registry（后端）

- `workers/registry/migrations/0007_skillset_metadata.sql`
  - `skills.skillset`, `skills.dependencies_json`, `discover_items.skillset`
- `workers/registry/src/index.ts`
  - 发布接口接收 `skillset` 与 `dependencies`
  - 技能/发现接口返回 `skillset`
- `workers/registry/src/discover-items.ts`
  - Discover 返回 `skillset` 字段

### Console（前端）

- `apps/console/src/components/skillset-badge.tsx`
  - 统一 Skillset 标记组件（避免多处重复实现）
- `apps/console/src/lib/skillset.ts`
  - `skillset` 标记归一化 + `dependencies_json` 解析辅助
- `apps/console/src/ui/pages/SkillsPage.tsx`
  - Discover 列表显示 Skillset 标记
- `apps/console/src/ui/pages/SkillDetailPage.tsx`
  - 详情页显示 Skillset 标记
  - Skillset 展示 `dependencies` 列表（Bundled / Registry link）
- `apps/console/src/ui/pages/MySkillsPage.tsx`
  - Publisher 列表显示 Skillset 标记

---

## 关键规则落地

- Skillset 本体始终安装到顶层
- 外部依赖扁平化安装到顶层
- 相对路径依赖安装在 skillset 目录内（保留结构）
- 相对路径必须在 skillset 根目录内
- 版本冲突直接报错

---

## 验证方法与记录

- `pnpm lint`
- `pnpm typecheck`
- `pnpm build`
- `pnpm dev:smoke`

执行结果：通过

### Example Skillset（仓库内示例）

- `examples/hello-skillset`
  - `skillset: true`
  - `dependencies` 为相对路径内联依赖（不会触发 registry 安装）
- `examples/kitchen-sink-skillset`
  - 包含内联依赖 + GitHub 依赖 + Registry 依赖（更贴近真实 Skillset）
- `examples/registry-dep-skill`
  - 用于本地 registry 发布的依赖 skill（供 kitchen-sink smoke 使用）
- `skillsets/awesome-claude-skills/*`
  - 基于 `VoltAgent/awesome-claude-skills` 的 curated Skillsets（依赖指向 upstream GitHub skills）

本地安装验证（project scope，避免污染 repo）：

```
TMP="$(mktemp -d /Users/peiwang/Projects/skild/.tmp/skillset-smoke.XXXXXX)"
node /Users/peiwang/Projects/skild/packages/cli/dist/index.js install /Users/peiwang/Projects/skild/examples/hello-skillset --target codex --local --json
find "$TMP/.codex/skills/hello-skillset" -maxdepth 4 -type f -name 'SKILL.md' -print
```

预期：
- 安装目录存在 `hello-skillset/skills/*/SKILL.md`（内联依赖保留结构）
- `.skild/install.json` 包含 `skillset: true` + `installedDependencies`

执行结果：通过

Kitchen-sink 端到端安装验证（inline + github + registry）：

```
pnpm build:cli
node scripts/dev/skillset-kitchen-sink-smoke.mjs
```

预期：
- 自动启动本地 registry、注册/登录、发布 `registry-dep-skill`
- `skild install @<handle>/registry-dep-skill` 可直接解析 `latest` dist-tag（不显式传 `--registry` / `SKILD_REGISTRY_URL`）
- 安装 `kitchen-sink-skillset` 后 `installedDependencies` 同时包含：`inline`、`degit-shorthand`/`github-url`、`registry`
- 使用 `SKILD_HOME` 隔离测试，不污染真实 `~/.skild`

执行结果：通过

Awesome Claude Skillsets 安装验证（GitHub deps）：

```
TMP="$(mktemp -d /Users/peiwang/Projects/skild/.tmp/skillset-awesome-smoke.XXXXXX)"
node packages/cli/dist/index.js install ./skillsets/awesome-claude-skills/claude-office-pack --target codex --local --json
find "$TMP/.codex/skills" -maxdepth 2 -name SKILL.md -print
```

执行结果：通过

### 本地 Registry 发布/验证（仅 smoke）

启动本地 registry：

```
pnpm dev:registry
```

注册/登录/发布：

```
node packages/cli/dist/index.js signup --registry http://localhost:18787 --email <email> --handle <handle> --password <password>
node packages/cli/dist/index.js login --registry http://localhost:18787 --handle-or-email <handle> --password <password>
node packages/cli/dist/index.js publish --dir examples/hello-skillset --registry http://localhost:18787 --json
```

接口校验（skillset + dependencies_json）：

```
curl -fsS 'http://localhost:18787/skills/<handle>/hello-skillset'
curl -fsS 'http://localhost:18787/discover?q=hello-skillset'
```

执行结果：通过

### 功能验证（手动）

```
mkdir -p tmp-skillset/subskill
cat > tmp-skillset/SKILL.md <<'EOF'
---
name: local-pack
description: local pack
version: 0.1.0
skillset: true
dependencies:
  - ./subskill
---
EOF

cat > tmp-skillset/subskill/SKILL.md <<'EOF'
---
name: inline-skill
description: inline skill
version: 0.1.0
---
EOF

skild install ./tmp-skillset
skild list
skild uninstall local-pack
```

预期：
- `local-pack` 安装在顶层目录
- `local-pack/subskill/` 作为内联依赖存在
- `skild list` 显示 skillset 标记与依赖关系

执行结果：通过

---

## 发布部署流程

- 本迭代涉及 `@skild/core` 与 `skild`（CLI）发布
- 依流程执行（见 `docs/processes/npm-release-process.md`）
- Console 本次为 UI 改动，未执行线上部署

发布结果：
- `skild@0.2.3`
- `@skild/core@0.2.3`

### 本次全量发布闭环（含 Registry/Console）

NPM（Core + CLI）：
- 版本：`@skild/core@0.2.4`、`skild@0.2.4`

Registry（Cloudflare Workers + D1）：
- migrations apply：`workers/registry/migrations/0007_skillset_metadata.sql`
- deploy：`workers/registry` -> `registry.skild.sh`
- 线上冒烟：
  - `GET https://registry.skild.sh/health` -> `{ ok: true }`
  - `GET https://registry.skild.sh/skills?limit=1` -> `skills[*].skillset` 字段存在
  - `GET https://registry.skild.sh/discover?limit=1` -> `items[*].skillset` 字段存在

Console（Cloudflare Pages）：
- deploy：`apps/console` -> `hub.skild.sh` / `console.skild.sh`
- 线上冒烟：
  - `GET https://hub.skild.sh/` -> 200

### 后续发布：`skild@0.2.5`（CLI UX 修复）

- NPM：已发布 `@skild/core@0.2.5`、`skild@0.2.5`
- 变更：修复交互式 `skild login` 的密码提示行（`Password:`）不可见问题（输入仍保持隐藏）
- 本次不涉及 Registry/Console/DB 变更，无需 migrations/deploy

### 后续发布：`skild@0.2.6`（CLI UX 修复）

- NPM：已发布 `@skild/core@0.2.6`、`skild@0.2.6`
- 变更：修复交互式密码输入在编辑（如 Backspace）时提示行异常的问题（改为 raw-mode 密码输入；输入仍保持隐藏）
- 本次不涉及 Registry/Console/DB 变更，无需 migrations/deploy
