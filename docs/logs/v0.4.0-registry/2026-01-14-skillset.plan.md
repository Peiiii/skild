# 2026-01-14 Skillset 迭代计划（v0.4.0-registry）

> 目标: 引入 Skillset 组合安装能力，保持与现有 Skill 规范兼容。

---

## 范围

- 支持 `skillset: true` + `dependencies` 语义
- CLI 安装/列表/卸载支持依赖关系
- 安装结果与元数据跟踪

非目标（本迭代不做）：
- 自动版本冲突解决
- 依赖树可视化
- Registry 端新增新 API 或数据表

---

## 规格约定（最小可行）

### SKILL.md frontmatter

```yaml
---
name: data-analyst-pack
version: 1.0.0
description: All-in-one skill pack
skillset: true
dependencies:
  - @scope/skill@^1.0.0
  - owner/repo/path#ref
  - https://github.com/owner/repo/tree/main/path
  - ./utils/lint-rules
---
```

### 依赖类型

- Registry: `@scope/skill[@version|tag|range]`
- GitHub: `owner/repo/path#ref` 或 `https://github.com/...`
- Relative: `./path`（相对 skillset 根目录）

### 安装规则

- Skillset 本体: 始终安装到顶层 `~/.<platform>/skills/<skillset>`
- 外部依赖: 扁平化安装到顶层
- 相对路径依赖: 保留目录结构，安装在 skillset 目录内
- 相对路径安全: 必须在 skillset 根目录内，禁止路径逃逸
- 版本冲突: MVP 直接报错

---

## 元数据与状态

- `.skild/install.json` 增加:
  - `skillset: true`
  - `dependencies: string[]`
  - `installedDependencies: [{ name, source, sourceType, canonicalName?, installDir?, inlinePath? }]`
  - `dependedBy: string[]`
- lockfile 仍按已安装 skill 记录，不新增 schema

---

## CLI 行为

- `skild install`: 解析依赖并安装
- `skild list`: 标记 skillset + 依赖关系
- `skild uninstall --with-deps`: 卸载仅被该 skill 依赖的项

---

## 前端标示

- Discover 列表与 Skill 详情页显示 Skillset 标记
- Publisher “My Skills” 列表显示 Skillset 标记

---

## 验证方法

- `pnpm lint`
- `pnpm typecheck`
- `pnpm build`
- `pnpm dev:smoke`

### 功能验证（手动）

1) 构造本地 skillset 与内联依赖

```
./tmp-skillset/
├── SKILL.md
└── subskill/
    └── SKILL.md
```

`./tmp-skillset/SKILL.md` 示例：

```yaml
---
name: local-pack
description: local pack
version: 0.1.0
skillset: true
dependencies:
  - ./subskill
---
```

`./tmp-skillset/subskill/SKILL.md` 示例：

```yaml
---
name: inline-skill
description: inline skill
version: 0.1.0
---
```

2) 安装并检查结果

```
skild install ./tmp-skillset
skild list
```

期望结果：
- 顶层包含 `local-pack` 目录
- `local-pack/subskill/` 存在且包含 `SKILL.md`

3) 卸载与依赖行为

```
skild uninstall local-pack
```

期望结果：只移除 `local-pack`，不影响其他已安装 skill。

---

## 发布部署流程

- 本迭代仅涉及 CLI/Core 逻辑变更，按发布流程执行 npm 包发布：
  - 参考 `docs/processes/npm-release-process.md`

---

## 风险与边界

- 内联依赖不被 Agent 直接扫描（仅 skillset 私有）
- 依赖来源冲突（同名不同源）直接报错
- 依赖循环直接报错

---

## 验证

- `pnpm lint`
- `pnpm typecheck`
- `pnpm build`
- `pnpm dev:smoke`
